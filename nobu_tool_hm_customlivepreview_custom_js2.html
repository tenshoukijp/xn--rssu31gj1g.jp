%(hilight)s
<h2><i class="fa fa-book fa-fw"></i>秀丸エディタ・HmCustomLivePreviewのカスタム 初級編</h2>

<ul class="checklist">
    <li>
    <h3>概要</h3>
    <p>ここでは、前節「秀丸エディタ・HmCustomLivePreviewのカスタム 入門編」の続きです。</p>
    <li>
    <h3>HmCustomLivePreviewImg.macの作成</h3>
    <p>それでは、HmCustomLivePreviewHr.macをコピーして、HmCustomLivePreviewImg.macとしましょう。</p>
    <p>今回は、テキスト上にイメージファイルを見つけると、<br>
    それをイメージタグへと自動的に変換してHmCustomLivePreviewで画像状態として表示されるように組んでみます。</p>
    <li>
    <h3>「HmCustomLivePreviewImg.mac」編集</h3>
    <p>OnCustomTranslateHTML関数は、<span class="positive">基本的には１秒に１回実行されます。</span><br>
    </p>
    <p>引数として渡ってくるのが、<br>
    </p>
    <ul>
        <li>filename:現在秀丸で編集しているファイル名。まだファイル名が決まっていないない場合は、「""」が渡ってくる。<br>
        <li>rawtext&nbsp;:現在秀丸で編集している中身のテキスト。<br>
    </ul>
    <p>といった形となります。</p>
    <div class="code"><pre class="brush:python">
#dll = loaddll( currentmacrodirectory + @&quot;\HmCustomLivePreview.dll&quot; );
if (!#dll) {
  message(&quot;NO&quot;);
  endmacro;
}

#_ = dllfuncw( #dll, &quot;DoString&quot;, R&quot;JSCRIPT(

function OnCustomTranslateHTML(filename, rawtext) {

    var htmltext = rawtext;
    htmltext = htmltext.replace( /&lt;/g, &quot;&amp;lt;&quot;);
    htmltext = htmltext.replace( /&gt;/g, &quot;&amp;gt;&quot;);
    htmltext = htmltext.replace( /\n/g, &quot;&lt;br&gt;&quot;);

    htmltext = htmltext.replace(/---/g, &quot;&lt;hr&gt;&quot; );
    // ここまでは前回までの話

    // 画像と思われる正規表現をあなた独自に定義する。
    // ここでは「a-zA-Z0-9_\/」のいずれの文字列が連続しており、
    // その後に「.png」「.jpg」「.jpeg」「.bmp」「.gif」のいずれかの文字が続いていれば、
    // 画像とみなしている。
    // 厳密性は全くないが、「あなただけが利用する置換法則」なので、
    // あなたが要求する範囲を満たす正規表現ならなんでもよいのである。
    var re = /[a-zA-Z0-9_\\\/]+\.(png|jpe?g|bmp|gif)/g;

    // htmltext内に対象の「re」に当てはまる箇所を発見する度に、
    // 正規表現キャプチャー結果を引数として、image_regex_replacerを呼び出す。
    // 正規表現キャプチャーとは「(...)」で、当てはまる文字列を捕捉すること。キャプチャ結果とは捕捉された文字列のこと。
    htmltext = htmltext.replace(re, image_regex_replacer );
    return htmltext;
}

// $0はマッチした全体、$1は１つめの(...)、よって上の正規表現だと、「拡張子」に相当するのが$1
// $2は今回は利用していない。
function image_regex_replacer($0,$1,$2) {

    // マッチしてれば
    if ($0) {
        // 現在のカレントディレクトリはどこ？(=原則ファイルを開いている場所)
        // より正確には、filnameをグローバル変数にコピーし、clr.System.IO.Path.GetDirectoryName(...)などを利用する。
        var currentdir = clr.System.IO.Directory.GetCurrentDirectory();

        // イメージファイルのフルパスを求める。
        var imgfilefullpath = currentdir + &quot;/&quot; + $0;

        // そのファイルが実際にあれば…
        if ( clr.System.IO.File.Exists(imgfilefullpath) ) {
            // HTMLとして画像を描画できるように、イメージタグに変換する。
            var ret = $0;
            ret += &quot;&lt;br&gt;&lt;img src='&quot; + currentdir + &quot;/&quot; + $0 + &quot;'&gt;&lt;br&gt;&quot;;
            ret += &quot;拡張子&quot; + $1 + &quot;&lt;br&gt;&quot;

            return ret;

        // 無ければ、(not found)という文字列でもくっ付けておく。
        } else {
            return $0 + &quot;(not found)&quot;;
        }
    }

    return &quot;&quot;;
}

)JSCRIPT&quot;
);

#_ = dllfuncw( #dll, &quot;Show&quot;, hidemaruhandle(0) );
</pre></div>
    <p>これをHmCustomLivePreviewで見てみると、下図のようになります。</p>
    <p><img src="./other_soft/hm_customlivepreview/hm_customlivepreview_04.png"></p>
    <p><span class="negative">ライブ性は決して損なわれません。<br>
    この状態で秀丸上のテキストをいろいろと編集してみてください!!</span><br>
    １秒以内に、リアルタイムに編集が反映されるはずです。<br>
    (これがライブビューです)</p>
    <p>HmCustomLivePreviewを一度閉じましょう。</p>
</ul>