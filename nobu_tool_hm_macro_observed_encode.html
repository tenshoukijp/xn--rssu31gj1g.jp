%(hilight)s
<h2><i class="fa fa-check-square-o fa-fw"></i>秀丸エディタ・マクロ保存時の文字コード＆ＢＯＭの自動チェック</h2>

<ul class="checklist">
    <li>
        <h3>概要</h3>
        <p>
            秀丸マクロのファイルは、文字エンコードとして「sjis / utf8(bom付) / unicode(bom付)」のいずれかが想定されています。<br>
            このマクロは、マクロ保存時に「マクロファイルとして適切な文字コードになっているか」をチェックするためのマクロです。
        </p>
    <li>
        <h3>ダウンロード</h3>
        <dl>
            <dt>
                <div class="download_file">DOWNLOAD ⇒ <a href="%(file)s">HmOnSaveObserbedEncode.zip</a>ファイル。ver 1.001</div>
            </dt>
            <dd>
                <div class="update_time">└更新日 %(year)04d/%(mon)02d/%(mday)02d</div>
            </dd>
        </dl>
    <li>
        <h3>動作環境</h3>
        <ul>
            <li>秀丸 ver8.50以上。
        </ul>
    <li>
        <h3>使い方</h3>
        <p>
            「マクロ登録」⇒「自動起動」⇒「保存直前と直後」として該当マクロファイル(HmOnSaveObserbedEncode.mac)を登録する。<br>
            すでに「保存直前と直後」に別のマクロがあるのであれば、中身をコピペするなりexecmacroするなりする。

        </p>
        <p><img src="./other_soft/hm_macro_observed_enc/hm_macro_observed_enc_01.png"></p>
    <li>
        <h3>HmOnSaveObserbedEncodeマクロ内容</h3>
        <div class="code">
            <pre class="brush:hmmacro">
/*
 * HmOnSaveObserbedEncode v1.0.0.1
 * 秀丸 v8.50以上
 * パブリックドメイン
 */
OnFileSave_ObservedEncodeAsHidemaruMacro:

    if (filetype == &quot;.mac&quot;) {

        // セーブ時?
        // event==3 保存直前と直後
        if (event == 3) {

            // 保存直後?
            // event==3の時のgeteventparam(0)の返り値は、　0 保存直前 1 保存直後
            ##is_after_save = geteventparam(0);
            if (##is_after_save == 1) {
                ##encode_num = encode &amp; 0x3F;

                // utf8? or utf16?
                if (##encode_num==2 || ##encode_num==6) {
                    if (!bom) {
                        setencode encode, 1, 1;
                        save;

                        ##OUT = loaddll(&quot;HmOutputPane.dll&quot;);
                        #ret = dllfunc(##OUT, &quot;Output&quot;,hidemaruhandle(0),&quot;秀丸マクロと判断した場合、BOMが必要です。\r\n ⇒ BOMを付与しました。\r\n&quot;);
                        freedll(##OUT);

                    }
                }

                // sjis?
                else if (##encode_num==1) {
                    ; // なし
                }

                // その他。
                // ワザとでもない限り、日本人がマクロ保存時にここに突入してはこないだろう…
                // 別言語圏の人が、その圏で主要なマルチバイト等で保存した、など？
                else {
                    // 多バイト文字っぽいのが含まれているか?

                    // 文字数とバイト数が異なれば…といった趣旨
                    if (charcount(0x00000000|0x00000000|0x00000000|0x00000000|0x00200000) != 
                        charcount(0x00000001|0x00000000|0x00000100|0x00000000|0x00200000)) {

                        ##OUT = loaddll(&quot;HmOutputPane.dll&quot;);
                        #ret = dllfunc(##OUT, &quot;Output&quot;,hidemaruhandle(0),
                            &quot;秀丸マクロと判断した場合、不正な文字コードです。\r\n ⇒ sjis / utf8(bom) / unicode(bom) のいずれかで保存してください。\r\n&quot;
                        );
                        freedll(##OUT);
                    }
                }
            }
        }
    }
</pre>
        </div>
    <li>
        <h3>関連項目①</h3>
        <p><a href="?page=nobu_tool_hm_event_macro_tips">自動マクロのまとめ方</a>を参照のこと。</p>
    <li>
        <h3>関連項目② ～秀丸のデフォルトの文字コードをUTF8に～</h3>
        <p>
            2017年現代では、大半のテキストファイルはUTF8で扱うことが多くなってきています。<br>
            一方で、UTF8のファイルにBOMを付けるか否かは、「拡張子やプロジェクトにより」揺れがあるのが実情です。<br>
        </p>
        <p>
            しかし、一旦、秀丸のデフォルトの文字コードをShiftJISではなく、UTF8にしておき、<br>
            <span class="negative">上記マクロを拡張子等の判定を加えるなど、多少変更する</span>だけで、<br>
        </p>
        <ul>
            <li>「UTF8でBOMを付ける必要があるモノ」には付け、<br>
            <li>「UTF8でBOMを付ける必要がないモノ」には外す、<br>
        </ul>
        <p>といった自動制御が簡単に出来ることでしょう。</p>
        <p><img src="./other_soft/hm_macro_observed_enc/hm_macro_observed_enc_02.png"></p>
        <p><img src="./other_soft/hm_macro_observed_enc/hm_macro_observed_enc_03.png"></p>
    <li>
        <h3>ライセンス</h3>
        <p>パブリックドメインです。</p>
</ul>