%(hilight)s
<h2><i class="fa fa-list fa-fw"></i>チュートリアル② ～ウィンドウの描画～</h2>

<ul class="checklist">
    <li>
    <h3>概要</h3>
    <p>前節では、コールバックからデバッグ領域に表示するといったものでした。</p>
    <p>これだけの単純な仕組みであっても
    自分なりの制作物を展開していくことが出来ることでしょう。</p>
    <li>
    <h3>単純なウィンドウ表示</h3>
    <div class="code"><pre class="brush:cpp;">
#include &lt;windows.h&gt;

using namespace System;
using namespace System::Drawing;
using namespace System::Windows::Forms;


public ref class ACHelpForm : public Form
{
public:
  static ACHelpForm^ f; // 自分自身の置き場
public:
  ACHelpForm()
  {
    SetFormAttr();

    // 最初は非表示
    this-&gt;Visible = false;
  }

public:
  // 入力補完の候補リストのどれかを選択している時に呼ばれる。
  void Update(HWND hWnd, int iListBoxSelectedIndex, String^ strListBoxSelectedItem, int iItemHeight)
  {
    RECT rect;
    GetWindowRect(hWnd, &amp;rect);
    this-&gt;Left = rect.right + 24;
    this-&gt;Top = rect.top;
    this-&gt;Width = (rect.right - rect.left) * 2;
    this-&gt;Height = 160;
    this-&gt;Show();
  }


protected:
  // 独立したアプリケーショではなく、子窓のように見せるための工夫
  void SetFormAttr()
  {
    //タイトルバーを消す。秀丸の中のウィンドウかのように振る舞うための工夫。
    this-&gt;ControlBox = false;
    this-&gt;Text = &quot;&quot;;
    this-&gt;FormBorderStyle = ::FormBorderStyle::None;
    this-&gt;BackColor = ::Color::Gray;
  }

  // このフォームが表示された際にアクティブにならないようにする
  property bool ShowWithoutActivation
  {
    virtual bool get() override
    {
      return true;
    }
  }

  // このフォームがマウスクリックされた際にアクティブにならないようにする。
  virtual void WndProc(Message %m) override
  {
    if (m.Msg == WM_MOUSEACTIVATE)
    {
      m.Result = (IntPtr)MA_NOACTIVATE;
      return;
    }

    Form::WndProc(m);
  }

};


extern &quot;C&quot; __declspec(dllexport) int OnCreate(HWND hWnd, LPCTSTR szFileName) {

  // ウィンドウの作成
  if (ACHelpForm::f == nullptr || ACHelpForm::f-&gt;IsDisposed) {
    ACHelpForm::f = gcnew ACHelpForm();
  }

  return TRUE;
}

extern &quot;C&quot; __declspec(dllexport) int OnListBoxSelectedIndexChanged(HWND hWnd, int iListBoxSelectedIndex, LPCTSTR szListBoxSelectedItem, int iItemHeight) {

  // そのまま伝達
  ACHelpForm::f-&gt;Update(hWnd, iListBoxSelectedIndex, gcnew String(szListBoxSelectedItem), iItemHeight);

  return TRUE;
}


extern &quot;C&quot; __declspec(dllexport) int OnDestroy(HWND hWnd) {

  // ウィンドウの破棄
  if (ACHelpForm::f) {
    ACHelpForm::f-&gt;Close();
  }
  // このOnDestroyの後に、インスタンスが残っているのに任せるのは不安である。明示的に解放
  if (ACHelpForm::f) {
    OutputDebugString(&quot;明示解放\n&quot;);
    delete ACHelpForm::f;
  }

  return TRUE;
}

</pre></div>
    <li>
    <h3>再度コンパイル</h3>
    <p>再度コンパイルし、「HmAutoCompleteExPlug.dll」を秀丸ディレクトリにコピーしましょう。<br>
    秀丸が立ち上がりっぱなしだと、コピー出来ないので、一旦秀丸を終了させる必要があります。</p>
    <p>再び、.plファイルを読み込んで、何か入力補完を出し、単語を選択してみましょう。<br>
    以下のように、ねずみ色のウィンドウが表示されたでしょうか。<br>
    </p>
    <p>大切なことはこのウィンドウが、</p>
    <ul>
        <li><b>秀丸より前方に描画されているが、アクティブではない。</b>
        <li><b>マウスで選択しても、アクティブにはならない</b>
    </ul>
    <p>ということです。</p>
    <p><img src="./other_soft/hm_autocompleteex/hm_autocompleteex_exam_07.png"></p>
    <li>
    <h3>解説</h3>
    <p>全体としては、.NETのフォームアプリケーションの代表的な形そのものです。<br>
    「System.Windows.Forms.Form」から継承しているため、ボタンやラベルや描画など、<br>
    便利なものが全て極めてわかりやすい形で利用可能です。<br>
    <br>
    とはいえ、おそらくあまり見慣れない記述もあるため、要点だけピックアップしましょう。<br>
    <div class="code"><pre class="brush:cpp;">

  // 独立したアプリケーショではなく、子窓のように見せるための工夫
  void SetFormAttr()
  {
    //タイトルバーを消す。秀丸の中のウィンドウかのように振る舞うための工夫。
    this-&gt;ControlBox = false;
    this-&gt;Text = &quot;&quot;;
    this-&gt;FormBorderStyle = ::FormBorderStyle::None;
    this-&gt;BackColor = ::Color::Gray;
  }

  // このフォームが表示された際にアクティブにならないようにする
  property bool ShowWithoutActivation
  {
    virtual bool get() override
    {
      return true;
    }
  }

  // このフォームがマウスクリックされた際にアクティブにならないようにする。
  virtual void WndProc(Message %m) override
  {
    if (m.Msg == WM_MOUSEACTIVATE)
    {
      m.Result = (IntPtr)MA_NOACTIVATE;
      return;
    }

    Form::WndProc(m);
  }


</pre></div>
    <p>これらは、いずれも先ほどの<br>
    <b>「フォーカスを取らない・アクティブにしない」といったことを実装するための工夫</b>です。<br>
    </p>
    <br>
    <br>
    <div class="code"><pre class="brush:cpp;">
  // 入力補完の候補リストのどれかを選択している時に呼ばれる。
  void Update(HWND hWnd, int iListBoxSelectedIndex, String^ strListBoxSelectedItem, int iItemHeight)
  {
    RECT rect;
    GetWindowRect(hWnd, &amp;rect);
    this-&gt;Left = rect.right + 24;
    this-&gt;Top = rect.top;
    this-&gt;Width = (rect.right - rect.left) * 2;
    this-&gt;Height = 160;
    this-&gt;Show();
  }
  </pre></div>
    <p>この部分は<b>入力補完窓の位置に合わせて、自分自身(Form)が位置や大きさを決めている</b>部分です。<br>
    単語補完ウィンドウが大きい人は、このフォームも大きくなり、小さい人は小さくなるということです。</p>
</ul>