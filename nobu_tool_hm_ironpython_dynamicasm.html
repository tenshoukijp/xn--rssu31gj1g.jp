%(hilight)s
<h2><i class="fa fa fa-book fa-fw"></i>マクロから渡した関数名でリアルタイムにdllを生成する</h2>
<ul class="checklist">
    <li>
    <h3>概要</h3>
    <p>.NET Frameworkは、「System.Reflection」を利用することで、クラスやメソッド等をリアルタイムに生成するだけではなく、<br>
    .dllや.exeへと具体的にコンパイルするメソッドまでをも提供しています。</p>


    <p>以下のファイルをdynamicasm.macとして保存します。</p>
    <div class="code"><pre class="brush:python">
#PY = loaddll( hidemarudir + @&quot;\hmPy.dll&quot; );

#_ = dllfuncw(#PY, &quot;DoString&quot;, R&quot;IPY(

my_sum_method_name = &quot;hm_sum&quot;;

)IPY&quot;
);


#_ = dllfuncw(#PY, &quot;DoString&quot;, R&quot;IPY(

from System import *
from System.Threading import *
from System.Reflection import *
from System.Reflection.Emit import *

try:
    my_sum_method_name = my_sum_method_name
except:
    my_sum_method_name = &quot;myfunc&quot;

def addMethodDynamically(typeBuilder, methodName, methodParams, returnType):
    methodBuilder = typeBuilder.DefineMethod(
                                     methodName,
                                     MethodAttributes.Public | MethodAttributes.Static,
                                     returnType,
                                     methodParams
                                     )
    ILout = methodBuilder.GetILGenerator()
    numParams = len(methodParams)
    x = 0
    while x &lt; numParams:
        ILout.Emit(OpCodes.Ldarg_S, x)
        x += 1
    y = 0
    while y &lt; (numParams - 1):
        ILout.Emit(OpCodes.Add)
        y += 1
    ILout.Emit(OpCodes.Ret)


def main():

    domain = Thread.GetDomain()
    asmName = AssemblyName()
    asmName.Name = &quot;DynamicAssembly&quot;

    asmBuilder = domain.DefineDynamicAssembly(asmName, AssemblyBuilderAccess.RunAndSave)
    module = asmBuilder.DefineDynamicModule(&quot;DynamicModule&quot;, &quot;DynamicAsm.dll&quot;)
    typeBuilder = module.DefineType(&quot;DynamicType&quot;, TypeAttributes.Public)

    global my_sum_method_name
    methodName = my_sum_method_name
    inputNumsList = (2, 3, 4, 5)

    methodParams = Array[Type]((Int32, Int32, Int32, Int32))
    inputValsList = Array[object](inputNumsList)

    returnType = Int32

    # Now, call the method building method with the parameters, passing the TypeBuilder.
    addMethodDynamically(typeBuilder, methodName, methodParams, returnType)
    myType = typeBuilder.CreateType()
    result = myType.InvokeMember(methodName,
                            BindingFlags.InvokeMethod | BindingFlags.Public | BindingFlags.Static,
                            None, None,
                            inputValsList
                           )
    hm.debuginfo( &quot;入力された数値の総計: %s&quot; % result )
    hm.debuginfo( &quot;---&quot; )

    # ダイナミックにMSILを生成しています。
    asmBuilder.Save(&quot;DynamicAsm.dll&quot;)
    methodInfo = myType.GetMethod(methodName)
    hm.debuginfo( &quot;生成したメソッド: %r;&quot; % methodInfo )


main()

)IPY&quot;
);

freedll( #PY );
</pre></div>
    <h3>出来上がったDynamicAsm.dllをILSpyで見ると</h3>
    <p>以下のように秀丸マクロで渡したパラメータに基づいて、.dllが出来上がっているのがわかります。</p>
    <p><img src="./other_soft/hm_ironpython/cnt_hm_ironpython_dynamicasm.png"></p>
</ul>