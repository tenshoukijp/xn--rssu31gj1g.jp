%(hilight)s
<h2><i class="fa fa-book fa-fw"></i>「hmPy・IronPython」のその他の例題 CSVの読み込み</h2>

<ul class="checklist">
    <li>
    <h3>概要</h3>
    <p>IronPythonの例題のひとつとなります。<br>
    </p>
    <p>難解なCSVデータであっても正しく読み取るためのサンプルです。<br>
    </p>

    <p>マネージドdll(.NET用DLL)だけ公開されているような「配布ライブラリ」を、<br>
    hmPyを経由して、いかに手軽に秀丸マクロから利用するか、といったサンプルでもあります。</p>
    <p><img src="./other_soft/hm_ironpython/cnt_hm_ironpython_csvhelper_02.png"></p>
    <li>
    <h3>ダウンロード</h3>
    <dl>
        <dt>
        <div class="download_file">DOWNLOAD ⇒ <a href="%(file)s">CsvHelper.zip v1.30</a>ファイル。</div>
        </dt>
        <dd>
        <div class="update_time">└更新日 %(year)04d/%(mon)02d/%(mday)02d</div>
        </dd>
    </dl>
    <h3>説明</h3>
    <p>秀丸のマクロで「非常に難解なCSVデータであっても」、Excelと同程度相当の読み取り精度を誇る<br>
    CsvHelper.dllをマクロ内で利用するサンプルとなります。</p>
    <p><span class="positive">上記zipファイルには一式が入っていますので、.mac内のファイル指定と、.csvのパスの位置は合わせるようにしてください。</span></p>


    <fieldset class="alert alert-info"><legend>難解なCSVデータが含まれている例</legend><br>
    <img src="./other_soft/hm_ironpython/cnt_hm_ironpython_csvhelper_01.png" attr="noedge"><br>
    (※残念ながら「秀丸本体」はこのCSVを正しく解釈できません)</fieldset>

    <h3>IronPythonの部分</h3>
    <p>IronPythonの部分で.NET FrameworkのライブラリとなるCsvHelperを読み込み、秀丸マクロから取り扱えるインターフェイスにしましょう。 <br>
    今回は、単純に２次元データとして読み込んでいますが、CsvHelperの本領は、<br>
    <span class="positive">クラスデータ構造と直接紐づけ可能なことにありますので</span>IronPythonであれば、どちらにでもテキスト記述で対応できます。<br>
    </p>
    <p>また、今回のサンプルでは触れていませんが、CsvHelperは読み込みだけではなく、書き込みにも利用することが可能です。<br>
    詳細は<a href="https://joshclose.github.io/CsvHelper/">CsvHelper Githubサイト</a>を確認してください。</p>
    <div class="code"><pre class="brush:python">
# coding: cp932

# このcsvhelper.pyはただのサンプルコードです。ご自由にお使いください。

# 途中エラーでもクリアしておかねばならない
CsvAllData = []
RowCount = 0


import clr
import sys
sys.path.append(hm.Macro.Var[&quot;currentmacrodirectory&quot;])
clr.AddReferenceByPartialName( &quot;CsvHelper&quot;)
clr.AddReferenceByPartialName( &quot;System.Windows.Forms&quot; )

import System.IO
import System.Text
import System.Collections.Generic

from CsvHelper import *

# デバッグ用途
__PYDEBUG__ = 0
if __PYDEBUG__:
	class HM:
	    def debuginfo(self, str):
	        print(str+&quot;\n&quot;)

	hm = HM()
	target_csv_filename = r&quot;C:\usr\hidemaru\csvhelper\a.csv&quot;


try:
    target_csv_filename = target_csv_filename
except:
    System.Windows.Forms.MessageBox.Show(&quot;ファイル名が指定されていません。&quot;, &quot;エラー&quot;, System.Windows.Forms.MessageBoxButtons.OK, System.Windows.Forms.MessageBoxIcon.Error)
    raise IOError


try:
    target_csv_encoding = target_csv_encoding
except:
    target_csv_encoding = &quot;shift_jis&quot;
    hm.debuginfo(&quot;エンコーディングの指定が無いため、csvはCP932(SJIS)の文字コードとみなします&quot;)


try:
    encoding = System.Text.Encoding.GetEncoding(target_csv_encoding)
except:
    hm.debuginfo(&quot;存在しないエンコーディング名の指定。CP932(SJIS)の文字コードとみなします&quot;)
    target_csv_encoding = &quot;shift_jis&quot;
    encoding = System.Text.Encoding.GetEncoding(target_csv_encoding)


try:
    print(target_csv_filename)
    file_stream = System.IO.StreamReader(target_csv_filename, encoding)
    parser = CsvParser(file_stream);
except Exception:
    System.Windows.Forms.MessageBox.Show(&quot;CSVファイルの読み取りエラー&quot;, &quot;エラー&quot;, System.Windows.Forms.MessageBoxButtons.OK, System.Windows.Forms.MessageBoxIcon.Error)
    System.Console.WriteLine(Exception)
    if file_stream:
        file_stream.Close()
    raise IOError



RowCount = 0
while (True):
    try:
        row_data = parser.Read();
        if row_data == None:
            break;

        # 全体のデータに１行足す
        CsvAllData.append(row_data[:])
        print(row_data)
        RowCount = RowCount + 1
    except:
        break;


file_stream.Close();

# データ全体の行数
def GetRowCount():
    return RowCount

# 対象の１行内のデータ数を得る
def GetColCount(row_ix):
    try:
        global CsvAllData
        row_data = CsvAllData[row_ix]
        return row_data.Count
    except:
        hm.debuginfo(&quot;データの範囲外です&quot;)
        raise IndexError


# 指定のセルデータを得る
def GetCellItem(row_ix, col_ix):
    try:
        return CsvAllData[row_ix][col_ix]
    except:
        hm.debuginfo(&quot;データの範囲外です&quot;)
        return &quot;&quot;

</pre></div>
    <li>
    <h3>マクロ側の処理</h3>
    <p>マクロ側では「読み込むファイル」や「対象ファイルの文字コード」を指定することとなるでしょう。<br>
    指定可能なエンコーディング文字については、「<a href="http://dobon.net/vb/dotnet/string/getencodingobject.html">http://dobon.net/vb/dotnet/string/getencodingobject.html</a>」などを参照してください。</p>
    <div class="code"><pre class="brush:python;highlight:[14,15]">
// このcsvhelper.macはサンプルコードです自由にご利用ください。

#PY = loaddll( hidemarudir + @&quot;\hmPy.dll&quot; );

if (!#PY) {
    message(&quot;hmPyが未導入のようです&quot;);
    endmacro;
}

// 前準備
// サンプルにあるようなcsvファイルのフルパスを指定してください。
#_ = dllfuncw(#PY, &quot;DoString&quot;, R&quot;IPY(

target_csv_filename = &quot;C:\\work\\test.csv&quot;; 
target_csv_encoding = &quot;shift_jis&quot;;

)IPY&quot;
);

// csvhelper.pyを実行
#IS = dllfuncw(#PY, &quot;DoFile&quot;, currentmacrodirectory + @&quot;\csvhelper.py&quot; );

// 実際のデータを得る
#_ = dllfuncw(#PY, &quot;DoString&quot;, R&quot;IPY(

data_row_count = GetRowCount()
hm.debuginfo(&quot;全部で何行:&quot; + str(data_row_count))

data_item = GetCellItem(1, 2)
hm.debuginfo(&quot;Cell(1,2)のデータ:&quot; + data_item);


)IPY&quot;
);

freedll(#PY);
    </pre></div>


    <li>
    <h3>ライセンス</h3>
    <ul class="pointlist">
        <p>HmCsvHelper.zipのLICENSE.txt内に記載されています。</p>
        <li>
        <h4>HmCsvHelper.mac, HmCsvHelper.pyのについて</h4>
        <p>パブリックドメインとします。(即ち利用は自由)</p>
        <li>
        <h4>CsvHelper.dllについて</h4>
        <p>Josh Close著作物であり、MS-PL 及び、Apache ライセンス 2.0 のデュアルライセンスとなります。<br>
        詳細は<a href="https://joshclose.github.io/CsvHelper/">CsvHelper Githubサイト</a>を確認してください。</p>
    </ul>
</ul>