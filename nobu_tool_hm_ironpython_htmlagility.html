%(hilight)s
<h2><i class="fa fa-book fa-fw"></i>HTMLの高度なパース</h2>

<ul class="checklist">
    <li>
    <h3>概要</h3>
    <p>IronPythonの例題のひとつとなります。<br>
    </p>
    <p>少々崩れたHTMLデータであってもDOMとして解析し、要素の抽出や置き換えが可能な <a href="https://htmlagilitypack.codeplex.com/">HTML Aglity Pack</a> を利用したサンプルです。<br>
    </p>

    <p>マネージドdll(.NET用DLL)だけ公開されているような「配布ライブラリ」を、<br>
    hmPyを経由して、いかに手軽に秀丸マクロから利用するか、といったサンプルでもあります。</p>
    <p><img src="./other_soft/hm_ironpython/cnt_hm_ironpython_htmlagility_01.png"></p>
    <li>
    <h3>ダウンロード</h3>
    <dl>
        <dt>
        <div class="download_file">DOWNLOAD ⇒ <a href="%(file)s">hmHtmlAgility.zip v.1.20</a>ファイル。</div>
        </dt>
        <dd>
        <div class="update_time">└更新日 %(year)04d/%(mon)02d/%(mday)02d</div>
        </dd>
    </dl>
    <p>このhmHtmlAgility.zipには変換元のHTMLとなるサンプルファイルa.htmlが含まれています。</p>
    <h3>説明</h3>
    <p>HTMLの要素を解析し、その中身を取り出したい、といったことは珍しいことではありません。<br>
    しかし、「フォーマット的に正しいことが期待できるXMLやRSS」とは異なり、<br>
    HTMLは人の手が多分に混じっていることが多いため、不正なフォーマット(崩れた状態の)ものが多いの特徴です。<br>
    (一つも誤りがないHTMLの方が珍しいことでしょう)</p>

    <h3>IronPythonの部分</h3>
    <p>IronPythonの部分では、HTML Agility Packを利用しつつ、<br>
    「HTMLのロード」「toInnerText」「toInnerHtml」「新たなHTMLへのセーブ」という４つの関数に分けて制作してみました。 秀丸マクロから呼び出されることを意識したインターフェイスと言えるでしょう。</p>
    <div class="code"><pre class="brush:python">
#coding: cp932

DEBUG = 1

import clr
import sys
sys.path.append(hm.Macro.Var[&quot;currentmacrodirectory&quot;])

import System
import System.IO
import System.Text
import System.Collections.Generic


clr.AddReferenceByPartialName( &quot;HtmlAgilityPack&quot;)
clr.AddReferenceByPartialName( &quot;System.Windows.Forms&quot; )

from HtmlAgilityPack import *
from System.Collections.Generic import *

load_html_filename = hm.Macro.Var[&quot;$load_html_filename&quot;]
save_html_filename = hm.Macro.Var[&quot;$save_html_filename&quot;]
file_encode = hm.Macro.Var[&quot;#encode&quot;]

doc = &quot;&quot;


# htmlのロード。秀丸から操作しやすくするためにこのような単純なインターフェイスで
def LoadHTML():
    global doc
    si = None
    try:
        si = System.IO.StreamReader( load_html_filename, System.Text.Encoding.GetEncoding(file_encode) )
    except:
        System.Windows.Forms.MessageBox.Show(&quot;load_html_filename中にエラーが発生しました&quot;)
        if si:
            si.Close()
        raise IOError

    doc = HtmlDocument()
    doc.LoadHtml(si.ReadToEnd())
    si.Close()


# 対象のタグの中身はテキストだけになる(タグも除去される)
def toInnerText(tag):
    global doc
    q = doc.DocumentNode.Descendants(tag)
    l = List[HtmlNode](q)
    for item in l:
        newNodeStr = item.InnerText
        newNode = HtmlNode.CreateNode(newNodeStr)
        item.ParentNode.ReplaceChild(newNode, item)


# 対象のタグは除去するが、他のタグは残る
def toInnerHtml(tag):
    global doc
    q = doc.DocumentNode.Descendants(tag)
    l = List[HtmlNode](q)
    for item in l:
        newNodeStr = item.InnerHtml
        newNode = HtmlNode.CreateNode(newNodeStr)
        item.ParentNode.ReplaceChild(newNode, item)


# htmlのセーブ。秀丸から操作しやすくするためにこのような単純なインターフェイスで
def SaveHTML():
    global doc
    try:
        so = System.IO.StreamWriter( save_html_filename, False, System.Text.Encoding.GetEncoding(file_encode) )
        so.Write(doc.DocumentNode.InnerHtml)
        so.Close()
    except:
        System.Windows.Forms.MessageBox.Show(&quot;save_html_filename中にエラーが発生しました&quot;)
        if so:
            so.Close()
        raise IOError
</pre></div>
    <li>
    <h3>マクロ側の処理</h3>
    <p>マクロ側では「ロードファイル」や「セーブファイル」を指定することとなるでしょう。<br>
    今回はエンコーディングについては、「UTF-8」固定としました。<br>
    ローカルなどの作業用テキストなどとは異なり、<br>
    Web用のHTMLについては、近年では様々な都合により、ほとんどのケースでUTF-8で記述されているようです。</p>
    <p>マクロとして開いている html ファイルに対して…</p>
    <ul>
        <li><span class="negative">titleタグについては、中身のテキストだけに置き換える(タグを除去)</span>
        <li><span class="negative">blockquoteタグについては、中身のHTMLだけに置き換える(一番外のblockquoteタグだけを除去)</span>
    </ul>
    <p>それを 元のファイル名 + 「_up.html」という形にして秀丸で開いています。</p>
    <div class="code"><pre class="brush:python">
#PY = loaddll( hidemarudir + &quot;\\hmPY.dll&quot; );
if (!#PY) {
  message(&quot;hmPYが未導入&quot;);
}
 
 
$load_html_filename = filename2;
$save_html_filename = directory2 + &quot;\\&quot; + basename2 + &quot;_up.html&quot;;
#encode = codepage;
 
#_ = dllfuncw( #PY, &quot;DoFile&quot;, currentmacrodirectory + &quot;\\hmHtmlAgility.py&quot; );

#_ = dllfuncw( #PY, &quot;DoString&quot;, R&quot;IPY(

LoadHTML()
toInnerText('title')
toInnerHtml('blockquote')
SaveHTML()

)IPY&quot;
);

freedll( #PY );

openfile $save_html_filename;
    </pre></div>
    <li>
    <h3>ライセンス</h3>
    <ul class="pointlist">
        <li>
        <h4>hmHtmlAgility.pyとhmHtmlAgility.macについて</h4>
        <p>パブリックドメインとします。(即ち利用は自由)</p>
        <li>
        <h4>Html Agility Packについて</h4>
        <p>Simon Mourierの著作物であり、Microsoft Public License(Ms-PL) ライセンスとなります。<br>
        詳細は<a href="http://htmlagilitypack.codeplex.com/license">Html Agility Packのライセンス</a>を確認してください。</p>
    </ul>
</ul>