%(hilight)s
<h2><i class="fa fa-ps fa-fw"></i>hmPS (秀丸マクロ用 PowerShell)</h2>
<ul class="checklist">
    <li>
        <p>秀丸マクロで「<span class="positive">PowerShellの多くの機能をシームレスに近い形で利用する</span>」ためのライブラリとなります。<br></p>
        <p>
            PowerShellは、Windows 10以降では「標準コンソール」であり、<br>
            「(テキストではなく)オブジェクトがベース」というかなり先進的なとしたコンソールとなっています。</p>
            <p>PowerShellの拡張コマンドは、ユーザーが.NET Frameworkで作成するのが基本であることからもわかるように、<br>
        .NETと深い繋がりがあるコンソールであるとともに、<br>
            旧来の「テキストを受け取り、テキストを出力する」コンソールアプリケーションもシームレスに動作するようになっています。
        </p>
    <li>
        <h3>秀丸マクロとPowerShellの連携</h3>
        <ul class="pointlist">
            <li>
                HTMLにJavaScriptを埋め込むような感覚で、秀丸マクロにPowerShellを文字列として埋め込むことが出来ます。<br> 複数個所に埋め込んでも、記述の内容は持続性を持っています。
                <br> 又、HTMLに対するJavaScript同様に、中に埋め込むのではなく、ファイルの外に記述してもかまいません。
                <br>
        </ul>
        <h3>ダウンロード</h3>
        <dl>
            <dt>
                <div class="download_file"><img src="./other_soft/hm_powershell/cnt_hm_powershell_minizip.png" attr="noedge" align="middle"> ⇒ <a href="%(file)s">hmPS.zip</a>ファイル。ver 1.481</div>
            </dt>
            <dd>
                <div class="update_time">└更新日 %(year)04d/%(mon)02d/%(mday)02d</div>
            </dd>
        </dl>
    <li>
        <h3>動作環境</h3>
        <ul class="pointlist">
            <li>
                <h4>秀丸</h4>
                <p>秀丸エディタ ver8.66以上</p>
            <li>
                <h4>PowerShell</h4>
                <p>PowerShell は ver5以上が対象となります。</p>
            <li>
                <h4>Microsoft VC++ 再頒布可能パッケージ</h4>
                <p>
                    <a href="https://www.microsoft.com/ja-jp/download/details.aspx?id=48145">Visual Studio 2015 C++ ランタイム</a><br> x86版をインストールしたことが無い方はインストールしてください。
                    <br>
                    <span class="negative">お手持ちのOSが64bitか32bitかには関わりなく、x86版のインストールが必要です。</span>
                </p>
            <li>
                <h4>Microsoft .NET</h4>
                <p>
                    .NET Framework 4.5以上。<br>
                </p>
            <li>
                <h4>秀丸エディタ 64bit版について</h4>
                <p>秀丸エディタ64bit版をご利用の方は、<a href="/other_soft/hm_ironruby/hmPS_x64.zip">hmPS_x64.zip</a>をダウンロードし、hmPS.dllを差し替えてください。<br> (又、この場合は、Microsoft VC++ 再頒布可能パッケージは、64bit版をインストールしてください。)</p>
        </ul>
    <li>
        <h3>インストール</h3>
        <ul>
            <li>hmPS.zipを解凍する。
            <li>
                <span class="negative">「hmPS.dll」を秀丸エディタのディレクトリ内(hidemaru.exeと同じ場所)へと コピー</span>する。<br> (
                <span class="negative">原則的には、hidemaru.exeと同じ場所である必要があります。これは.NET FrameWorkのdllを動作させる仕組みに拠るためです。)</span>
        </ul>
    <li>
        <h3>利用シーン</h3>
        <ul class="pointlist">
            <li>
                <h4>PowerShellのコマンド・コンソールコマンド・.NETのAPIの機能をシームレスに!!</h4>
                <p>
                    PowerShellは、「コマンド系」としての性質と「.NETライブラリを使えるスクリプト」という２つの顔を持っています。<br>
                    <ul>
                        <li>文字列処理
                        <li>ウィンドウズの各機能へのアクセス
                        <li>各種GUIコンポーネントやイベントハンドラ
                        <li>インターネット上のデータの取得
                        <li>各種ファイル処理
                        <li>並列スレッド
                        <li>簡易な数学計算
                    </ul>
                <p>
                    に至るまで、.NET Frameworkをシームレスに利用しながら、処理を記述することが可能です。<br>
                </p>
            <li>
                <h4>秀丸エディタ 8.66 以降では、PowerShellをそのままマクロ内に記述出来る!!</h4>
                <p>
                    秀丸エディタ 8.66にて、「ヒアドキュメント」が実装されたため、<br>PowerShellをそのままマクロ内に記述出来るようになりました。(エスケープ等の必要性がなくなりました!)
                    <br> 詳細は後述されています。
                </p>
            <li>
                <h4>PowerShellから秀丸マクロの変数やシンボルにアクセス出来る!! 秀丸マクロも実行できる!!</h4>
                <p>この機能により、「秀丸マクロならでわの機能」と「PowerShellの機能」が融合し、飛躍的に実装の幅が広がりました。</p>
        </ul>
    <li>
        <h3>OS標準のシェルスクリプトであるという安心感</h3>
        <ul class="pointlist">
            <li>
                <h4>hmV8やhmPyといったものと比べると言語自体は劣る</h4>
                <p>
                    ES6+.NETとなるhmV8や、IronPythonをベースとしたhmPyなどと比べると、<br>
                    言語それ自体の成熟度はやや落ちます。<br>
                    しかしながら、「今後浸透が確実な、Windows OS標準の、コンソールコマンド兼スクリプト」という独特な立ち位置は、<br>
                    「2030年ぐらいまではまず安泰。使えなくなる可能性が極めて低い」といった安心感があります。
                </p>
            <li>
                <h4>C#で独自に制作した.dllが読み込みしやすい</h4>
                <p>
                    元々用意されている.NETのクラスのみならず、<br> 独自に自作したマネージドの.dllがPowerShellでは使いやすくなっています。<br>
                    又、「PowerShell用途に適したC#等によるコマンドレットの作り方」もMicrosoftが提供しています。
                </p>
            <li>
                <h4>１つのdllで動作する!!</h4>
                <p>
                    <span class="positive">hmPS.dllだけで動作</span>します。<br>
                    又、秀丸マクロと同じプロセス空間(インプロセス)で動作していますので、ガッチリ秀丸と完全連携します。<br>
                </p>
        </ul>
        <h3>ファイルの文字コード</h3>
        <p>
            <span class="positive">
                hmPSは「秀丸マクロ」「.psファイル」共に<br>
                「utf-8(BOM有)」もしくは「utf-16(BOM有)」で記述することを想定
            </span> しています。<br> (.psファイルに限っては「utf-8(BOM無)」にも対応しています。)
        </p>
    <li>
        <h3>「w付き」関数を利用のこと</h3>
        <p>「dllfuncではなく、必ず「dllfunc<b>w</b>」を、dllfuncstrではなく、「dllfuncstr<b>w</b>」を使ってください。</p>
    <li>
        <h3>注意点</h3>
        <ul class="pointlist">
            <li>
                "PowerShellは<span class="posotive">「それぞれのプロセスでの最初の起動」がとても遅いです。</span><br>
                よって、何か<span class="posotive">「既存のPowerShellの資産の流用」や「PowerShell以外のスクリプト記述方法がどうしても分からなかった」といった場合を除き、<br>
    普段使いでは、hmV8、hmPy、hmRb、hmJSなどの使用をオススメ</span>します。
</ul>
<li>
        <h3>一番簡単なソース例</h3>
        <p>「秀丸マクロ・マクロ変数」「PowerShell」「.NET Framework」をまぜこぜに出来るため、非常に強力なパワーがあります。</p>
        <ul class="pointlist">
            <li>
                <h4>.NET FrameWorkを使って、ダイアログ表示</h4>
                <div class="code">
                    <pre class="brush:ps">
#PS = loaddll( hidemarudir + @&quot;\hmPS&quot; );

#_ = dllfuncw( #PS, &quot;DoString&quot;, R&quot;PS(
[System.Reflection.Assembly]::LoadWithPartialName(&quot;System.Windows.Forms&quot;)

$test = &quot;表示&quot;
if ($test -match &quot;^表.+&quot;) {
    [Windows.Forms.MessageBox]::Show( &quot;秀丸からのメッセージ&quot;, &quot;秀丸からのタイトル&quot;, [Windows.Forms.MessageBoxButtons]::YesNoCancel )
}

)PS&quot;
);

freedll(#PS);
</pre>
                </div>
                <p><img src="./other_soft/hm_ironpython/cnt_hm_ironpython_04.png"></p>
            <li>
                <h4>.NET FrameWorkを使って、秀丸とインタラクティブに機能するフォームの例</h4>
                <div class="code">
                    <pre class="brush:ps">
#PS = loaddll( hidemarudir + @&quot;\hmPS&quot; );

#_ = dllfuncw( #PS, &quot;DoString&quot;, R&quot;PS(
[System.Reflection.Assembly]::LoadWithPartialName(&quot;System.Windows.Forms&quot;)

class MyForm {
    [int] $counter;
    [System.Object] $form
    [System.Object] $btn

    SetForm() {
        $this.form = New-Object System.Windows.Forms.Form;
        $this.form.Text = &quot;こんにちわ&quot;;
    }

    SetButton() {
        $this.btn = New-Object System.Windows.Forms.Button;
        $this.btn.Text = &quot;クリック&quot;;
        $this.btn.Left = 16;
        $this.btn.Top = 16;
        $this.btn.Width = 100;
        $this.btn.Height = 40;
        $this.btn.Tag = $this;

        # イベントハンドラも作れる
        $this.btn.Add_Click({
            ($sender, $event) = ($this, $_);
            btn_Click($sender, $event);
        });

        $this.form.Controls.Add($this.btn);
    }

    Show() {
        $this.counter = 0;
        $this.SetForm();
        $this.SetButton();
 
        $this.form.ShowDialog();
    }

}


function btn_Click($sender, $event) {
    $sender.Tag.counter++;

    # デバッグモニター用の関数
    $hm::debuginfo(&quot;ボタンが押されたよ!!&quot;);
    $hm::debuginfo($sender.Tag.counter);

    # 秀丸マクロの「変数」とのやりとりも自由自在
    ($filename2) = $hm::Macro::Var['filename2'];
    $hm::debuginfo($filename2);

    # 秀丸マクロの「変数」とのやりとりも自由自在
    $hm::Macro::Var['$counter'] = [string]$sender.Tag.counter
    # PowerShellの中から秀丸マクロを一連のコマンドとして実行することも出来る。
    # PowerShellには「ヒアドキュメント」が使えるのでちょうどよい
    $hm::Macro::Eval(
@'
        // アウトプット枠へ出力
        #OP = loaddll(&quot;HmOutputPane.dll&quot;);
        #ret = dllfunc(#OP, &quot;Output&quot;,hidemaruhandle(0), $counter);
        freedll(#OP);
'@  );
    }



$f = New-Object MyForm;
$f.Show();

)PS&quot;
);

freedll(#PS);
        </pre>
                </div>
                <p><img src="./other_soft/hm_powershell/cnt_hm_powershell_24.png"> <img src="./other_soft/hm_powershell/cnt_hm_powershell_25.png"></p>
        </ul>
    <li>
        <h3>ライセンス</h3>
        <ul class="pointlist">
            <li>
                <h4>hmPS</h4>
                <p>
                    hmPSは、Apache License 2.0となります。<br>
                </p>
                <h4>ソースの場所</h4>
                <ul>
                    <li><a href="https://github.com/vscode-life/hidemaru-net/tree/master/win-hidemaru-app/hm_powershell">Github</a>にソースがあります。<br>
                </ul>
        </ul>
</ul>