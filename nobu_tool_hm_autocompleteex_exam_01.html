%(hilight)s
<h2><i class="fa fa-book fa-fw"></i>チュートリアル① ～「HmAutoCompleteEx.dll」利用方法 開発準備編～</h2>

<ul class="checklist">
  <li>
  <h3>概要</h3>
  <p>この章より、いくつかのステップに分けて、「HmAutoCompleteEx.dll」の利用方法を解説してゆきます。</p>
  <li>
  <h3>チュートリアルが目指すもの</h3>
  <p>チュートリアルの最終目標は「プログラミング言語 Perl」用の入力補完拡張用の.dllを作成することになります。<br>
  (Perlの話題自体は登場しません。)<br>
  話がブレないよう、チュートリアルの目標を統一し、理解を促進するためとなります。<br>
  </p>
  <li>
  <h3>Perl言語の設定</h3>
  <p>秀丸の「ファイルタイプ別の設定」を利用して、「.pl」という拡張子に対して、<br>
  下画像のような設定を施しておきましょう。<br>
  これから行っていくチュートリアルの動作確認の上で、
  <ul>
    <li>「リスト」が選択されていること、<br>
    <li>「現在編集中のテキスト」にチェックが入っていること。<br>
    <li>可能であれば、何らかのPerl用の「辞書ファイル」をネット等から拾ってきて、設定しておくとよいでしょう。<br>
  </ul>
  <p>(<span class="negative">大切なことは「入力補完のウィンドウ」を出しやすくして確認しやすくすること、<br>
  「入力補完ウィンドウ」中に上下等で選択出来るタイプの「リスト」であることです。)</span></p>
  <p><img src="./other_soft/hm_autocompleteex/hm_autocompleteex_exam_02.png" attr="noedge"></p>
  <li>
  <h3>SDKのダウンロード</h3>
  <dl>
    <dt>
    <div class="download_file">DOWNLOAD ⇒ <a href="%(file)s">HmAutoCompleteExPlug.zip</a>ファイル。ver 0.802</div>
    </dt>
    <dd>
    <div class="update_time">└更新日 %(year)04d/%(mon)02d/%(mday)02d</div>
    </dd>
    <dt>
  </dl>
  <p>上記ファイルに含まれるプロジェクトを利用していくことで、「HmAutoCompleteEx.dll」上で動作するファイルを作成することが出来ます。<br>
  </p>
  <li>
  <h3>プロジェクトに含まれる最小のサンプル</h3>
  <p>今回の最小サンプルは「入力補完まわりの機能を秀丸で使った時に、コールバック関数が呼ばれる」ので、<br>
  それをデバッグモニターで確認できるようにする、というものです。</p>
  <div class="code"><pre class="brush:cpp;">
#include &lt;windows.h&gt;
#include &quot;OutputDebugStream.h&quot;

#define MACRO_DLL extern &quot;C&quot; __declspec(dllexport)


MACRO_DLL int OnCreate(HWND hWnd, LPCTSTR pwszFileName) {
	OutputDebugStream(L&quot;OnCreate:%s\n&quot;, pwszFileName);
	return TRUE;
}
 
MACRO_DLL int OnListBoxSelectedIndexChanged(HWND hWnd, int iListBoxSelectedIndex, LPCTSTR pwszListBoxSelectedItem, int iItemHeight) {
	OutputDebugStream(L&quot;OnListBoxSelectedIndexChanged:%s\n&quot;, pwszListBoxSelectedItem);
	return TRUE;
}

MACRO_DLL int OnDestroy(HWND hWnd) {
	OutputDebugStream(L&quot;OnDestroy\n&quot;);
	return TRUE;
}

using AUTOCOMPLETELIST = void;
MACRO_DLL AUTOCOMPLETELIST* OnQueryListBoxCustomAdded(HWND hWnd, AUTOCOMPLETELIST *pAutoCompleteOriginalList) {
	OutputDebugStream(L&quot;OnQueryListBoxCustomAdded:\n&quot;);
	return NULL;
}

MACRO_DLL int OnKeyDown(HWND hWnd, WPARAM wParam) {
	OutputDebugStream(L&quot;OnKeyDown:%c\n&quot;, wParam);
	return TRUE;
}
</pre></div>
  <li>
  <h3>コンパイル</h3>
  <p>コンパイルする前に、「プロジェクト」の「プラットフォームツールセット」のバージョンが、<br>
  今使っているVisual Studioのバージョンと一致するか確認しましょう。<br>
  複数のVisual Studioがインストールされていれば別ですが、そうでない限り、プラットフォームツールセットとVisual Studioのバージョンは一致させる必要があります。<br>
  (要するにVisual Studio 2015を使ってる人は、下画像の赤線部分をVisual Studio 2015にするということ)</p>
  <p><img src="./other_soft/hm_autocompleteex/hm_autocompleteex_exam_04.png" attr="noedge"></p>
  <li>
  <h3>「HmAutoCompleteEx.dll」と「HmAutoCompleteExPlug.dll」を秀丸ディレクトリにコピー</h3>
  <p>コンパイルすることで、「HmAutoCompleteExPlug.dll」が出来上がりました。<br>
  <br>
  「HmAutoCompleteEx.dll」と「HmAutoCompleteExPlug.dll」を秀丸ディレクトリにコピーしましょう。</p>
  <li>
  <h3>呼び出す設定</h3>
  <p>HmAutoCompleteEx.dll自体はある程度自由に呼び出せますが、<br>
  最も相応しい呼び出し場所は、<br>
  秀丸マクロの「自動起動」から「アクティブ切り替え後」あたりで呼び出すといったものです。<br>
  <br>
  <img src="./other_soft/hm_autocompleteex/hm_autocompleteex_exam_05.png" attr="noedge"></p>
  <li>
  <h3>マクロ内容</h3>
  <div class="code"><pre class="brush:hmmacro;">
#HMACE = loaddll( hidemarudir + @&quot;\HmAutoCompleteEx.dll&quot; );
if (#HMACE) {
    #_ = dllfuncw( #HMACE, &quot;SetHidemaruHandle&quot;, hidemaruhandle(0), filename2 );
    #_ = dllfuncw( #HMACE, &quot;BindAutoCompleter&quot;, hidemarudir + &quot;\\HmAutoCompleteExPlug.dll&quot;, &quot;\\.pl$&quot; );
} else {
    message(&quot;dllが無い&quot;);
}
</pre></div>
  <p>#hmaceをfreedll(FreeLibrary)しないよう注意してください。<br>
  秀丸終了時に、#hmaceは自動的にfreedllされます。</p>

  <li>
  <h3>デバッグモニターの用意</h3>
  <p>普段デバッグモニターを利用していない人は、<br>
  当サイトにて<a href="http://秀丸マクロ.net/?page=nobu_tool_hm_debugmonitor">秀丸専用のデバッグモニター</a>を提供していますので<br>
  こちらを利用してください。<br>
  <br>
  他のデバッグモニターでも問題はありません。<br>
  (dbmonなどと検索してください)</p>
  <li>
  <h3>入力補完をしてみる</h3>
  <p>適当に「.pl」ファイルを秀丸で開いて、<br>
  実際に入力補完をして挙動を確かめてみましょう。<br>
  今回コンパイルしたコールバック関数が呼ばれている様子がわかるでしょうか。</p>

  <p><img src="./other_soft/hm_autocompleteex/hm_autocompleteex_exam_06.png">
  </p>
  <p><span class="negative">どのような入力補完がらみの操作をすると、どの関数がコールバックされるのか、確認すると良いでしょう。</span></p>
  <ul class="pointlist">
    <li>
    <h4>OnCreate</h4>
    <p>単語補完ウィンドウの生成直後。</p>
    <li>
    <h4>OnDestroy</h4>
    <p>単語補完ウィンドウが消滅直前。</p>
    <li>
    <h4>OnListBoxSelectedIndexChanged</h4>
    <p>単語補完リストの選択項目が変更された際に、変更前のものと変更後のものが続けざまに呼ばれる</p>
    <li>
    <h4>OnQueryListBoxCustomAdded</h4>
    <p>単語補完リストの項目内容が変更される際、続けざまに呼ばれる。</p>
    <li>
    <h4>OnKeyDown</h4>
    <p>秀丸上で、キーボードが押される度に呼び出される呼ばれる。</p>
  </ul>

  <li>
  <h3>次節からウィンドウ描画へ</h3>
  <p>今回のものはデバッグ領域に出すだけといった地味なものでしたが、<br>
  次節からいよいよウィンドウ描画へと入っていきます。<br>
  <br>
  しかし、心配は要りません。<br>
  .NETをベースとした解説であるため、簡単でありプログラム経験が浅い人でも理解しやすい、記述しやすいものとなっています。</p>
</ul>