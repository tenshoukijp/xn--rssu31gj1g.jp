%(hilight)s
<h2><i class="fa fa-book fa-fw"></i>秀丸エディタ・HmCustomLivePreviewのカスタム 入門編</h2>

<ul class="checklist">
    <li>
    <h3>概要</h3>
    <p>ここでは、具体的なカスタムの例を手順を追って説明します。</p>
    <li>
    <h3>HmCustomLivePreviewHr.mac作成</h3>
    <p>まずは、HmCustomLivePreviewDefault.macをコピーし、HmCustomLivePreviewHr.macを作成してください。<br>
    もちろん全て手で記述してもらっても良いのですが、<br>
    手で記述しても同じですので、ファイルのコピーからスタートしても良いでしょう。</p>
    <p>今回は「HmCustomLivePreviewHr.mac」という名前でコピーしたものとしましょう。</p>
    <li>
    <h3>HmCustomLivePreviewは、hmJSと同じ機能を持っている</h3>
    <p>HmCustomLivePreviewの動作のカスタマイズは、原則的には、<br>
    「<a href="?page=nobu_tool_hm_javascript">hmJS</a>」と同一エンジンの「.NETが使えるJScript(JScript.NETとは違います)」でカスタマイズしていきますので、<br>
    ある程度は「どういった記述が可能なのか」、hmJSのページで確認してください。<br>
    <li>
    <h3>エラーがあった場合</h3>
    <p><a href="?page=nobu_tool_hm_javascript_debugmonitor">デバッグメッセージ</a>のページにあるように、秀丸デバッグ出力モニターによって確認することとなります。<br>
    それほど長いスクリプトなどを記述することは想定していないため、エラー行数などは出ません。<br>
    (複雑なアルゴリズムを組む場合には、「C#・C++/CLI」で記述出来るようになっています。)</p>
    <li>
    <h3>はじめての「HmCustomLivePreviewHr.mac」編集</h3>
    <p>原則的には、「DoString」中の「OnCustomTranslateHTML(...)」関数の中身を編集することになります。<br>
    </p>
    <p>考えることはすごく単純です</p>
    <blockquote>秀丸エディタ上の<b>テキスト文字列が、引数として渡ってくる</b>ので、<br>
    ブラウザで自分の思うように描画できるよう、<br>
    テキストを<b>うまくHTML文字列へと加工して、返す</b>。</blockquote>
    <ul class="pointlist">
        <li>
        <h4>OnCustomTranslateHTMLはTick関数</h4>
        <p>OnCustomTranslateHTML関数は、<span class="positive">基本的には１秒に１回実行されます。</span><br>
        </p>
        <li>
        <h4>引数</h4>
        <ul class="arrowlist">
            <li>
            <h5>filename</h5>
            <p>現在秀丸で編集しているファイル名。<br>
            (新規作成文書など)まだファイル名が決まっていないない場合は、「""」が渡ってくる。<br>
            </p>
            <li>
            <h5>rawtext</h5>
            <p>現在秀丸で編集しているテキスト文字列そのまま<br>
            </p>
        </ul>
        </li>
        <li>
        <h4>返値</h4>
        <p>ブラウザで解釈して欲しい文字列。相手がブラウザなので基本的にHTMLやHTMLの断片となる。</p>
    </ul>
    <p>といった形となります。</p>
    <div class="code"><pre class="brush:python">
#dll = loaddll( currentmacrodirectory + @&quot;\HmCustomLivePreview.dll&quot; );
if (!#dll) {
  message(&quot;NO&quot;);
  endmacro;
}

#_ = dllfuncw( #dll, &quot;DoString&quot;, R&quot;JSCRIPT(

function OnCustomTranslateHTML(filename, rawtext) {
    // そのまま受け取って…
    var htmltext = rawtext;

    // そのまま返す
    return htmltext;
}

)JSCRIPT&quot;
);

#_ = dllfuncw( #dll, &quot;Show&quot;, hidemaruhandle(0) );
</pre></div>
    <p>これをHmCustomLivePreviewで見てみると、下図のようになります。</p>
    <p><img src="./other_soft/hm_customlivepreview/hm_customlivepreview_02.png"></p>
    <p>そう、HTMLはテキスト上での「改行やタブや１つ以上のスペース」は、<br>
    「空白スペース１つ」のような形でレンダリングしてしまいます。</p>
    <p>HTMLを記述したことがあれば、誰もが体験していることでしょう。</p>
    <p><span class="negative">この状態で秀丸上のテキストをいろいろと編集してみてください!!</span><br>
    １秒以内に、リアルタイムに編集が反映されるはずです。<br>
    (これがライブビューです)</p>
    <p>HmCustomLivePreviewを一度閉じましょう。</p>
    <li>
    <h3>超簡易HTMLエンコーダ</h3>
    <p>さて、とりあえず、最低限編集しているテキストに近い形の見た目とするため、<br>
    以下のように少し工夫をしてみましょう。<br>
    </p>
    <p>現在編集しているテキストを、HTMLで似たような見た目にするためには、<br>
    「&lt;」や「&gt;」を「&amp;lt;」や「&amp;gt;」といった変換し、<br>
    改行を「&lt;br&gt;」に変換します。<br>
    </p>
    <p>今回は、「---」という文字列を見かけると水平線となる「&lt;hr&gt;」に変換する、という処理も入れてみましょう。</p>
    <div class="code"><pre class="brush:python">
#dll = loaddll( currentmacrodirectory + @&quot;\HmCustomLivePreview.dll&quot; );
if (!#dll) {
  message(&quot;NO&quot;);
  endmacro;
}

#_ = dllfuncw( #dll, &quot;DoString&quot;, R&quot;JSCRIPT(

function OnCustomTranslateHTML(filename, rawtext) {
  var htmltext = rawtext;

    // まず、タグになってしまわないように、&lt;や&gt;を最初に処理
    htmltext = htmltext.replace( /&lt;/g, &quot;&amp;lt;&quot;);
    htmltext = htmltext.replace( /&gt;/g, &quot;&amp;gt;&quot;);

    // 改行は&lt;br&gt;にしておく
    htmltext = htmltext.replace( /\n/g, &quot;&lt;br&gt;&quot;);

    // 「---」を見つけると、全て「&lt;hr&gt;」に変換する
    htmltext = htmltext.replace(/---/g, &quot;&lt;hr&gt;&quot; );

    // 変換した文字列全体をかえす
    return htmltext;
}

)JSCRIPT&quot;
);
#_ = dllfuncw( #dll, &quot;Show&quot;, hidemaruhandle(0) );

</pre></div>
    <p>最低限、この程度やっておけば、そこそこな感じでしょう。</p>
    <p>これをHmCustomLivePreviewで見てみると、下図のようになります。</p>
    <p><img src="./other_soft/hm_customlivepreview/hm_customlivepreview_03.png"></p>
</ul>