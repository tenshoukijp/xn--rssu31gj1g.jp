%(hilight)s
<h2><i class="fa fa-book fa-fw"></i>「hmPy・IronPython」の例題⑥ Excelの操作</h2>

<ul class="checklist">
    <li>
    <h3>概要</h3>
    <p>IronPythonの例題のひとつとなります。<br></p>

    <h3>Excelの操作</h3>
    <p>.NETはExcelの操作にも向いているため、IronPythonでも非常にやりやすいと言えるでしょう</p>

    <div class="code"><pre class="brush:python">
#PY = loaddll( hidemarudir + @&quot;\hmPy.dll&quot; );

$xls_filename = R&quot;(C:\work\Sample.xlsx)&quot;;

#_ = dllfuncw(#PY, &quot;DoFile&quot;, currentmacrodirectory + &quot;\\excel1.py&quot;); // 外部ファイルの実行
 
freedll( #PY );
</pre></div>

    <h3>外部の「.py」ファイルを用意</h3>
    <p>上記マクロと同じディレクトリに、excel1.pyというファイルを用意しましょう。<br>
    文字コードはやはりcp932(sjis)なので、気をつけてください。<br>


    又、あらかじめ、「C:\work\Sample.xlsx」というパスでExcelファイルを用意しておいてください。
    </p>

    <div class="code"><pre class="brush:python">
# coding: cp932
import clr
clr.AddReferenceByPartialName(&quot;System.Runtime.InteropServices&quot;)
clr.AddReferenceByPartialName(&quot;System.Windows.Forms&quot;)

import System
from System import *
from System.Runtime.InteropServices import *
from System.Windows.Forms import *

filename = hm.Macro.Var[&quot;$xls_filename&quot;]

excelApp = None
workBooks = None
workBook = None
workSheets = None
range = None

try:
    # COM経由で開く。秀丸マクロもCOM機能はもってはいるが、取り扱いが大変になりすぎる傾向がある、IronPythonならお手軽である。
    excelAppType = Type.GetTypeFromProgID('Excel.Application')
    excelApp = Activator.CreateInstance(excelAppType)
    excelApp.DisplayAlerts = False

    workBooks = excelApp.WorkBooks
    workBook = workBooks.Open(filename)
    workSheets = workBook.Sheets
    workSheet = workSheets[1]
    range = workSheet.Cells
    range[1, 1] = &quot;テスト文字列&quot;
    workBook.Save()
    workBook.Close()

except Exception as e:
    System.Windows.Forms.MessageBox.Show(e.Message)
    pass
else:
    pass

finally:
    # 順次解放
    if range != None:
        Marshal.ReleaseComObject(range)
    if workSheet != None:
        Marshal.ReleaseComObject(workSheet)
    if workSheets != None:
        Marshal.ReleaseComObject(workSheets)
    if workBook != None:
        Marshal.ReleaseComObject(workBook)
    if workBooks != None:
        Marshal.ReleaseComObject(workBooks)
    if excelApp != None:
        Marshal.ReleaseComObject(excelApp)
</pre></div>
    <p><img src="./other_soft/hm_ironpython/cnt_hm_ironpython_14.png"></p>
</ul>