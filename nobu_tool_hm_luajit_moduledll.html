%(hilight)s
<h2><i class="fa fa-book fa-fw"></i>luaから使える関数をC/C++で作成(hmLJ用)</h2>

<ul class="checklist">
    <li>
    <h3>概要</h3>
    <p>luajitで関数作成するのには</p>
    <ul>
    <li>「lua」で記述する方法
    <li>「C/C++など」で記述する方法
    </ul>
    <p>の２通りあります。<br><br></p>
    <p>ここでは、躓きやすいC/C++でluaの関数を作成する方法が説明されています。</p>
    <p>全体像を把握する上でも、まずは、一度一通りの簡単な例を実装してみしょう<br>
    非常に簡単です。</p>
    <li>
    <h3>ダウンロード</h3>
    <dl>
        <dt>
        <div class="download_file"><img src="./other_soft/hm_luajit/cnt_hm_luajit_minizip.png" attr="noedge" align="middle"> ⇒ <a href="%(file)s">hmLJ.lib.zip</a>ファイル。ver 2.041</div>
        </dt>
        <dd>
        <div class="update_time">└更新日 %(year)04d/%(mon)02d/%(mday)02d</div>
        </dd>
    </dl>
    <p>このhmLJ.lib.zipファイルの中身は、「ヘッダーファイル」と「hmLJ.lib」ファイルであり、<br>後述のdllをコンパイルする上で必要となります。<br>
    (ヘッダーファイルは、hmLJ.dllを構成するLuaJITのソースファイルのうち、必要なものだけをピックアップしたものです)</p>

    <li>
    <h3>C/C++でwin32プロジェクトを作成</h3>
    <p>プロジェクトを作成しましょう。</p>
    <p><img src="./other_soft/hm_luajit/cnt_hm_luajit_31.png"></p>
    <p>空のプロジェクトとします。</p>
    <p><img src="./other_soft/hm_luajit/cnt_hm_luajit_32.png"></p>
    <p>文字セットはどちらでも良いのですが、秀丸の性質を考慮して、cp932としておきましょう。</p>
    <p><img src="./other_soft/hm_luajit/cnt_hm_luajit_33.png"></p>
    <li>
    <h3>ヘッダーファイルやhmLJ.libをコピー</h3>
    <p>プロジェクトファイルと同じ場所に「****.h」と「hmLJ.lib」をコピーします。</p>
    <p><img src="./other_soft/hm_luajit/cnt_hm_luajit_36.png"></p>
    <p>先ほどコピーしたファイルを、以下のようにプロジェクトファイルに追加しましょう。</p>
    <p><img src="./other_soft/hm_luajit/cnt_hm_luajit_34.png"></p>
    <p>これで、luajitのヘッダーファイルや、hmLJ.dll内の関数が利用できるようになりました。</p>

    <li>
    <h3>引数の数値を全て足した合計を返す関数の例</h3>
    <p>上図のようにソースを記述していきます。</p>
    <p>今回は「mysum.dll」を作成することになりますので、<br>
    「luaopen_mysum」という名前の関数をdllからdllexportしておく必要があります。</p>
    <div class="code"><pre class="brush:cpp">
extern &quot;C&quot; __declspec(dllexport) int luaopen_mysum(lua_State *L) {
</pre></div>
    <p>の部分がそれに相当します。<br>
    <span class="negative">dllの名前(****.dll)とdllexportする関数名「luaopen_****」の****部分は一致している必要があります。</span></p>
    <p>他の部分は、Luaの関数をC/C++で作る上での基本的な方法となります。<br>
    ネットや書籍にあふれていますので、検索してください。</p>
    <p><b>「luaL_register」などをキーワードとして検索する</b>とよろしいかと思います。</p>
    <div class="code"><pre class="brush:cpp">
#include &quot;lua.hpp&quot;

static int myfunc1(lua_State *L) {
    int n = lua_gettop(L);  /* 引数の数 */
    lua_Number dsum = luaL_checknumber(L, 1); // 一番上の値
    int i;
    for (i = 2; i &lt;= n; i++) {
        lua_Number d = luaL_checknumber(L, i);
        dsum += d;
    }
    lua_pushnumber(L, dsum);
    return 1; // 返り値の個数(スクリプト言語は通常「複数」の値を返すことが出来る)
}

static const luaL_Reg my_funcs[] = {
    { &quot;myfunc1&quot;, myfunc1 },
    { NULL, NULL }
};

extern &quot;C&quot; __declspec(dllexport) int luaopen_mysum(lua_State *L) {
    luaL_register(L, &quot;mysum&quot;, my_funcs);
    return 1;
}
</pre></div>
    <li>
    <h3>出来上がったmysum.dllをマクロファイルと同じ場所に配置</h3>
    <p>出来上がったmysum.dllは、今回のdllの呼び出し元となるマクロやlua(今回はtest.macやtest.lua)と同じ場所に置いておきましょう。</p>

    <li>
    <h3>hmLJから利用するためには</h3>
    <p>hmLJ.dllとマクロファイル(***.mac)やluaファイル(***.lua)は、<br>
    異なるディレクトリに置いているのが一般的だと思います。</p>
    <p><span class="positive">hmLJ.dllはhidemaru.exeと同じ場所ですが、各マクロファイルは、<br>
    「マクロの機能単位」でサブディレクトリ等各々別の場所にあることでしょう。</span></p>
    <p>しかし、そのような状態では、hmLJ.dllは今回作成したmysum.dllを発見することが出来ません。</p>
    <p>なぜなら秀丸は現在実行中のマクロ(*.mac)自体のディレクトリはちゃんと管理していますが、<br>
    lua層にはそのことが伝達されないためです。</p>
    <p><span class="negative"><b>そこで、currentmacrodirectoryをlua層に伝達して、lua層では .dllのパス検索の範囲を広げる必要があります。</b></span></p>
    <li>
    <h3>.mac側からマクロが存在するパス(=mysum.dllが存在するパス)を伝達する</h3>
    <p>以下のものをtest.macとして保存しましょう。</p>
    <p>現在のマクロのパスをlua層の変数へと伝達しておきます。</p>
    <div class="code"><pre class="brush:python">
#L = loaddll( hidemarudir + &quot;\\hmLJ.dll&quot;);

#_ = dllfunc( #L, &quot;SetStrVar&quot;, &quot;currentmacrodirectory&quot;, currentmacrodirectory );

#_ = dllfunc( #L, &quot;DoFile&quot;, currentmacrodirectory + &quot;\\test.lua&quot; );

freedll( #L );
</pre></div>
    <li>
    <h3>.lua側で伝達されたパスを検索対象に加える</h3>
    <p>以下のファイルを「test.lua」としましょう。<br>
    伝達された「currentmacrodirectory」をdll検索に加えてから、requireします。</p>
    <div class="code"><pre class="brush:lua">
-- カレントディレクトリがどこにあったとしても、
-- マクロファイルと同じフォルダにある自分で追加したdllを実行可能とするために、
-- cで作成したdllのパスを追加する。
package.cpath = package.cpath .. &quot;;&quot; .. currentmacrodirectory .. &quot;\\?.dll&quot;
-- 検索パスを秀丸デバッグモニターに表示
hm.debuginfo(package.cpath)

-- 今回作成したライブラリの読み込み
require(&quot;mysum&quot;)
-- 引数の数値の合計を秀丸デバッグモニターに表示
hm.debuginfo(mysum.myfunc1(1,2,3,4,5))
</pre></div>
<p>このようにすることで、ディレクトリの場所に依存することなく、<br>
自分で制作した独自のdllをLuaJIT内で利用可能となります。</p>
    <p><img src="./other_soft/hm_luajit/cnt_hm_luajit_35.png"></p>
</ul>