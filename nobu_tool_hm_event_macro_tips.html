%(hilight)s
<h2><i class="fa fa-puzzle-piece fa-fw"></i>自動起動マクロのまとめ方</h2>
<ul class="checklist">
    <li>
        <h3>概要</h3>
        <p>ここでは、自動起動マクロのまとめ方のチップが記載されています。</p>
        <h3>自動起動マクロのまとめ方</h3>
        <p>
            秀丸マクロの自動起動マクロは、個々のイベントにマクロファイルを設定することも出来ますが、<br>
            自動起動マクロは、そのイベントハンドラの特性上、<br>
            異なるイベントで似たような内容のものになることが多くあります。<br>
        </p>
        <p>
            例えば、「ファイルを開いた時」「新規作成時」「アクティブ切り替え時」などは、<br>
            同じ処理が必要なのではないか？<br>と考えられます。
        </p>
        <p>「ファイルを閉じた時」と「ファイルを保存した時」も同じ処理が必要かもしれません。</p>
        <h3>自動起動マクロはeventの番号で分け、ファイルは糾合する</h3>
        <p>
            そう考えた時、自動起動マクロは、以下のマクロのように、<br>「event番号」や「geteventparam」によるサブパラメータを利用し、<br>
            うまく切り分け、全体としてイベントハンドラ集のように作成することが想定されているようです。<br>
        </p>
        <fieldset class="code">
            <legend>OnEventMacros.mac</legend><pre class="brush:hmmacro">
/*
 * 自動起動マクロの、まとめ方のサンプル
 */


//===========================================================
// イベント番号に対応するラベルへと飛ぶ。
//-----------------------------------------------------------
$event_label = &quot;OnEvent_&quot; + sprintf(&quot;%02d&quot;, event);
goto $event_label;
//===========================================================


//===========================================================
// 自動起動マクロではない
//-----------------------------------------------------------
OnEvent_00:
	
	endmacro;
//===========================================================

//===========================================================
// ファイルを開いた直後
//-----------------------------------------------------------
OnEvent_01:
	##is_after_open = geteventparam(0);
	if (##is_after_open) {
		call OnPost_FileOpen;
	} else {
		call OnPrev_FileOpen;
	}

	endmacro;
//===========================================================

//===========================================================
// 新規作成直後
//-----------------------------------------------------------
OnEvent_02:
	call OnPost_NewDocumentMake;

	endmacro;
//===========================================================

//===========================================================
// 保存直前と直後
//-----------------------------------------------------------
OnEvent_03:
	##is_after_save = geteventparam(0);
	if (##is_after_save) {
		call OnPost_FileSave;
	} else {
		call OnPrev_FileSave;
	}

	endmacro;
//===========================================================

//===========================================================
// 印刷直前と直後
//-----------------------------------------------------------
OnEvent_04:
	
	endmacro;
//===========================================================

//===========================================================
// 編集後タイマー
//-----------------------------------------------------------
OnEvent_05:
	
	endmacro;
//===========================================================

//===========================================================
// カーソル移動後タイマー
//-----------------------------------------------------------
OnEvent_06:
	
	endmacro;
//===========================================================

//===========================================================
// ファイルを閉じる直前
//-----------------------------------------------------------
OnEvent_07:
	call OnPrev_FileClose;
	
	endmacro;
//===========================================================

//===========================================================
// 秀丸の対象ウィンドウがアクティブになった直後
//-----------------------------------------------------------
OnEvent_08:
	call OnPost_WindowFocus;

	endmacro;
//===========================================================


endmacro;

//===========================================================


//-----------------------------------------------------------
// 各実装
//-----------------------------------------------------------

//-----------------------------------------------------------
OnPrev_FileOpen:
	return;

//-----------------------------------------------------------
OnPost_FileOpen:
	return;

//-----------------------------------------------------------
OnPost_NewDocumentMake:
	return;

//-----------------------------------------------------------
OnPost_WindowFocus:
	return;

//-----------------------------------------------------------
OnPrev_FileSave:
	return;

//-----------------------------------------------------------
OnPost_FileSave:

	/*
	 * .macファイルなら、utf8やutf16ならBOMを自動付与、sjisなら何もなし
	 * それ以外なら、マルチバイト文字がはいっていれば、警告メッセージをアウトプット枠へ
	 */
	if (filetype == &quot;.mac&quot;) {

	    ##encode_num = encode &amp; 0x3F;

	    // utf8? or utf16?
	    if (##encode_num==2 || ##encode_num==6) {
	        if (!bom) {
	            setencode encode, 1, 1;
	            save;

	            ##OUT = loaddll(&quot;HmOutputPane.dll&quot;);
	            #ret = dllfunc(##OUT, &quot;Output&quot;,hidemaruhandle(0),&quot;秀丸マクロと判断した場合、BOMが必要です。\r\n ⇒ BOMを付与しました。\r\n&quot;);
	            freedll(##OUT);

	        }
	    }

	    // sjis?
	    else if (##encode_num==1) {
	        ; // なし
	    }

	    // その他。
	    // ワザとでもない限り、日本人がマクロ保存時にここに突入してはこないだろう…
	    // 別言語圏の人が、その圏で主要なマルチバイト等で保存した、など？
	    else {
	        // 多バイト文字っぽいのが含まれているか?

	        // 文字数とバイト数が異なれば…といった趣旨
	        if (charcount(0x00000000|0x00000000|0x00000000|0x00000000|0x00200000) != 
	            charcount(0x00000001|0x00000000|0x00000100|0x00000000|0x00200000)) {

	            ##OUT = loaddll(&quot;HmOutputPane.dll&quot;);
	            #ret = dllfunc(##OUT, &quot;Output&quot;,hidemaruhandle(0),
	                &quot;秀丸マクロと判断した場合、不正な文字コードです。\r\n ⇒ sjis / utf8(bom) / unicode(bom) のいずれかで保存してください。\r\n&quot;
	            );
	            freedll(##OUT);
	        }
	    }
	}

	return;


//-----------------------------------------------------------
OnPrev_FileClose:
	return;

</pre>
        </fieldset>

    </li>
</ul>