%(hilight)s
<h2><i class="fa fa-book fa-fw"></i>「hmPy・IronPython」から「ネイティブdll」のWin32 APIを利用する。</h2>

<ul class="checklist">
    <li>
    <h3>概要</h3>
    <p>「一般的なアプリケーション作成」ならいざ知らず、「組み込みマクロ」としての利用用途において、<br>
    巨大ライブラリ「.NET Framework」を利用できる「hmPy/IronPython」で、<br>
    わざわざ「Win32 API」を利用したい機会は、そう多くはないと思います。<br>
    <br>
    しかし、その口が用意されていないわけではありません。<br>
    <br>
    比較的簡単なWin32 APIであれば、以下のclrtype.pyを利用することでも対処は可能でしょう。<br>
    しかし、複雑な構造体を持つWin32 APIを利用したい場合は、C#でラップDLL作成を作成することを検討した方がよいでしょう。<br>
    <h3>clrtype.py</h3>
    <p>clrtype.pyとは、IronPythonにおいて、Win32 APIを利用するために、<br>
    Microsoftが作成した、簡易なIronPython用モジュールです。<br>
    １つのファイルだけで構成されています。<br>
    <li>
    <h3>ダウンロード</h3>
    <dl>
        <dt>
        <div class="download_file">DOWNLOAD ⇒ <a href="%(file)s">clrtype.py</a>ファイル。</div>
        </dt>
        <dd>
    </dl>
    <h3>インストール</h3>
    <p>秀丸のディレクトリ(hidemaru.exe)と同じ場所にコピー。<br>
    (※これは原本であって直接よまれる対象ではありません。)<br>
    (hmPy.dllやIronPython.dllも同じ場所にあるものとして解説します。)</p>
    <h3>使い方</h3>
    <p>C#でWin32 APIを利用していた方であれば、理解できる記述方法だと思われます。<br>
    生のIronPythonでは以下のように記述します。</p>

    <div class="code"><pre class="brush:python">
import clr
import clrtype
import System
from System.Reflection import BindingFlags

class Win32(object):
    __metaclass__ = clrtype.ClrClass

    from System.Runtime.InteropServices import DllImportAttribute
    DllImport = clrtype.attribute(DllImportAttribute)

    @staticmethod
    @DllImport("user32.dll")
    @clrtype.accepts(System.IntPtr, System.String, System.String, System.UInt32)
    @clrtype.returns(System.Int32)
    def MessageBox(hwnd, text, caption, type): raise RuntimeError("Runtime Error")

Win32.MessageBox(System.IntPtr.Zero, "Hello, Win32 API(IronPython) World!", "Hello, World!", 0)
</pre></div>
    <p>この.macファイルと同じフォルダにclrtype.pyをコピーしてください(これが実際に読み込まれる対象です)</p>
    <p>秀丸マクロ内のhmPyで記述すると、以下のようになります。</p>

    <div class="code"><pre class="brush:python">
 #PY = loaddll( hidemarudir + @&quot;\hmPy.dll&quot; );
 
#_ = dllfuncw(#PY, &quot;DoString&quot;, R&quot;IRONPYTHON(
import clr
import clrtype
import System
from System.Reflection import BindingFlags
class Win32(object):
    __metaclass__ = clrtype.ClrClass

    from System.Runtime.InteropServices import DllImportAttribute
    DllImport = clrtype.attribute(DllImportAttribute)

    @staticmethod
    @DllImport('user32.dll')
    @clrtype.accepts(System.IntPtr, System.String, System.String, System.UInt32)
    @clrtype.returns(System.Int32)
    def MessageBox(hwnd, text, caption, type): raise RuntimeError('Runtime Error')

Win32.MessageBox(System.IntPtr.Zero, 'Hello, Win32 API(IronPython) 秀丸 World!', 'Hello, 秀丸 World!', 0)

)IRONPYTHON&quot;
);
 
freedll(#PY);
</pre></div>
    <p><img src="./other_soft/hm_ironpython/cnt_hm_ironpython_09.png"></p>
    <h3>ライセンス</h3>
    <p>「clrtype.py」は、スクリプトファイル自体にライセンスが記載されており、<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>です。</p>
</ul>